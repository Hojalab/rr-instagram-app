<div class="container">
	<div class="row-fluid">
		<div class="span12">
			<h1 class="hidden">Instagram#trending</h1>
			<legend>
				Leaflet Map
			</legend>
			<div class="well">
				<div id="leaflet_map_canvas" style="min-height: 350px;" class="map-canvas"></div>
			</div>
			<div class="well well-small">
				<div class="message"></div>
				<div id="map_canvas" style="min-height: 300px;"></div>
			</div>
		</div>
	</div>
</div>
<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
<script src="http://jquery-ui-map.googlecode.com/svn/trunk/ui/min/jquery.ui.map.full.min.js"></script>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.css" />
<!--[if lte IE 8]>
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.ie.css" />
<![endif]-->
<link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
<script src="http://cdn.leafletjs.com/leaflet-0.5.1/leaflet.js"></script>
<script>
	$(document).ready(function() {
		var init = function() {
			// create a map in the "map" div, set the view to a given place and zoom
			var map = L.map('leaflet_map_canvas').setView([38.6883767, -121.27403729], 15);
			// add an OpenStreetMap tile layer
			L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
				attribution : '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
			}).addTo(map);
			// add a marker in the given location, attach some popup content to it and open the popup
			L.marker([38.6883767, -121.27403729]).addTo(map).bindPopup('Your current location').openPopup();
		}
		init();
		
		console.log(document)
		// addMarker returns a jQuery wrapped google.maps.Marker object
		var $marker = null;
		//Get users location
		function getLocation() {
			if(navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(showPosition);
			} else {
				$('.message').html("Geolocation is not supported by this browser.");
			}
		}

		function getTrendingData() {
			$.get('/data/locations.json').done(function(data) {
				console.log(data);
				$.each(data.data, function(index, obj) {
					addMarker(obj);
				});
			});
		}

		function addMarker(params) {
			var clientPosition = new google.maps.LatLng(params.latitude, params.longitude);
			$marker = $('#map_canvas').gmap('addMarker', {
				'position' : clientPosition,
				'bounds' : true,
				'zoom' : 10,
				'id' : params.id,
				'name' : params.name
			});
			$marker.click(function() {
				console.log(this);
				$('#map_canvas').gmap('openInfoWindow', {
					'content' : params.name
				}, this);
			});
		}

		//Place marker on map
		function showPosition(position) {
			//$('.message').html("Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude);
			var clientPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
			$marker = $('#map_canvas').gmap('addMarker', {
				'position' : clientPosition,
				'bounds' : true,
				'zoom' : 10
			});
			$marker.click(function() {
				$('#map_canvas').gmap('openInfoWindow', {
					'content' : "Latitude: " + position.coords.latitude + "<br>Longitude: " + position.coords.longitude
				}, this);
			});
			$('#map_canvas').gmap('addShape', 'Circle', {
				'strokeWeight' : 0,
				'fillColor' : "#008595",
				'fillOpacity' : 0.25,
				'center' : clientPosition,
				'radius' : 15,
				'clickable' : false
			});
		}

		//Init map and get users location
		$('#map_canvas').gmap().bind('init', function(evt, map) {
			getLocation();
			getTrendingData();
		});
	});

</script>
